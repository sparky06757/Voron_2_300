[include mainsail.cfg]
[include Macros.cfg]
[include DB_RB_led.cfg]
[include K-ShakeTune/*.cfg]

[delayed_gcode pre_heat]
initial_duration: .01
gcode:
  ABS_PREHEAT


[exclude_object]

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_30003A001750344D30353320-if00
restart_method: command

[mcu can0]
canbus_uuid: eb442146719f  #e87c5e5749f2

# [mcu RPi4]
# serial: /tmp/klipper_host_mcu

[temperature_sensor Octopus]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor can0]
sensor_type: temperature_mcu
sensor_mcu: can0
min_temp: 0
max_temp: 100

# [temperature_sensor RPi4]
# sensor_type: temperature_host
# min_temp: 0
# max_temp: 100

[temperature_sensor chamber]
sensor_type: Generic 3950
Sensor_pin: PF4

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[skew_correction]

[mcu scanner]
canbus_uuid: 7648b477a9a0 

[scanner]
mcu: scanner            
x_offset: 0                          
y_offset: 15                         
backlash_comp: 0.5
sensor: cartographer
sensor_alt: carto      
mesh_runs: 2

[bed_mesh]
zero_reference_position: 150, 150    
speed: 400
horizontal_move_z: 5
mesh_min: 25,25
mesh_max: 275, 275
probe_count: 20, 20
algorithm: bicubic

# [lis2dw]
# cs_pin: scanner:PA3
# spi_bus: spi1

# [resonance_tester]
# accel_chip: lis2dw
# probe_points:
#     150, 150, 20

[autotune_tmc stepper_x]
motor: ldo-42sth48-2004mah
tuning_goal: auto
voltage: 24

[autotune_tmc stepper_y]
motor: ldo-42sth48-2004mah
tuning_goal: auto
voltage: 24

[autotune_tmc stepper_z]
motor: ldo-42sth48-2004ac
tuning_goal: auto
voltage: 24

[autotune_tmc stepper_z1]
motor: ldo-42sth48-2004ac
tuning_goal: auto
voltage: 24

[autotune_tmc stepper_z2]
motor: ldo-42sth48-2004ac
tuning_goal: auto
voltage: 24

[autotune_tmc stepper_z3]
motor: ldo-42sth48-2004ac
tuning_goal: auto
voltage: 24

[input_shaper]
shaper_freq_x: 77.2 # center frequency for the X axis filter
shaper_type_x: mzv # filter type for the X axis
damping_ratio_x: 0.044 # damping ratio for the X axis
shaper_freq_y: 46.6 # center frequency for the Y axis filter
shaper_type_y: mzv # filter type for the Y axis
damping_ratio_y: 0.049 # damping ratio for the Y axis

[printer]
kinematics: corexy
max_velocity: 500  
max_accel: 12000
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 300
square_corner_velocity: 6.0
minimum_cruise_ratio: 0.5

[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400
endstop_pin: can0:PB8
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 80
homing_retract_dist: 0
homing_positive_dir: True

[tmc2209 stepper_x]
uart_pin: PC4
interpolate: false
run_current: 1.1
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400
endstop_pin: PG9
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 80  #Max 100
homing_retract_dist: 5
homing_positive_dir: true

[tmc2209 stepper_y]
uart_pin: PD11
interpolate: false
run_current: 1.1
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z]
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32
endstop_pin: probe:z_virtual_endstop     
position_max: 255
position_min: -5
homing_speed: 15
second_homing_speed: 3
homing_retract_dist: 0

[tmc2209 stepper_z]
uart_pin: PC6
interpolate: False
run_current: 1.1
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: False
run_current: 1.1
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z2]
step_pin: PF9
dir_pin: PF10
enable_pin: !PG2
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: False
run_current: 1.1
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z3]
step_pin: PC13
dir_pin: PF0
enable_pin: !PF1
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z3]
uart_pin: PE4
interpolate: False
run_current: 1.1
sense_resistor: 0.110
stealthchop_threshold: 0

[extruder]
step_pin: can0:PD0
dir_pin: !can0:PD1
enable_pin: !can0:PD2
rotation_distance: 22.67895
gear_ratio: 50:7
microsteps: 16
full_steps_per_rotation: 200
max_extrude_only_distance: 500
max_extrude_only_velocity: 120
max_extrude_cross_section: 50
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: can0:PB13
sensor_pin: can0:PA3
sensor_type: ATC Semitec 104NT-4-R025H42G
#pullup_resistor: 2200
#control: pid
#pid_Kp: 21.507
#pid_Ki: 1.887
#pid_Kd: 61.296
min_extrude_temp: 200
min_temp: 0
max_temp: 305
pressure_advance: .04
pressure_advance_smooth_time: 0.03

[tmc2209 extruder]
uart_pin: can0:PA15
interpolate: true
run_current: 0.8
hold_current: 0.100
sense_resistor: 0.11
stealthchop_threshold: 0
driver_TBL: 0
driver_HEND: 6
driver_HSTRT: 7
driver_TOFF: 4

[filament_motion_sensor filament_sensor]
detection_length: 12
extruder: extruder
switch_pin: ^PG15
pause_on_runout: True
event_delay: 3.0
pause_delay: 0.5
runout_gcode:
    M117 Runout Detected!

# [filament_motion_sensor encoder_sensor]
# detection_length: 12
# extruder: extruder
# switch_pin: PG15
# # changing the switch_pin name according to your motherboard
# #pause_on_runout: True
# #runout_gcode: [pause_resume]
# #insert_gcode:
# #event_delay: 
# #pause_delay:

[gcode_arcs]
resolution: 1.0

[heater_bed]
heater_pin: PA1
sensor_type: Generic 3950
sensor_pin: PF3
max_power: 0.6
min_temp: 0
max_temp: 125
pwm_cycle_time: 0.0166
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

[verify_heater heater_bed]
max_error: 50
check_gain_time: 99999
hysteresis: 5
heating_gain: 2

[idle_timeout]
timeout: 26000

[heater_fan hotend_fan]
#  Hotend Fan - FAN1
pin: can0: PA0
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 35
fan_speed: 1.0

## PART COOLING - FAN2
[fan]
pin: can0: PA1
kick_start_time: 0.5
#cycle_time: 0.15
off_below: 0.10

[heater_fan Electronics_Right]
pin: PD13
kick_start_time: 0.5
shutdown_speed: 0.0
heater: heater_bed
heater_temp: 50
fan_speed: .35

[heater_fan Electronics_Left]
pin: PD14
kick_start_time: 0.5
shutdown_speed: 0.0
heater: heater_bed
heater_temp: 50
fan_speed: .35

[heater_fan Nevermore]
pin: PD12
max_power: 1.0
kick_start_time: 0.5
heater: heater_bed
heater_temp: 50.0

[safe_z_home]                 
home_xy_position: 150,150
z_hop: 10


[quad_gantry_level]
gantry_corners:
	-60,-10
	360,370
points:
    25,0
    25,250
    275,250
    275,0
speed: 350
horizontal_move_z: 5
retries: 10
retry_tolerance: 0.006
max_adjust: 10


# [bed_mesh]
# speed: 400
# horizontal_move_z: 7
# mesh_min: 25,25
# mesh_max: 275,265
# fade_start: 0.6
# fade_end: 10.0
# probe_count: 30,30
# mesh_pps:2,2
# algorithm: bicubic

[bed_mesh] #cart bed mesh
zero_reference_position: 150, 150  
speed: 350
horizontal_move_z: 5
mesh_min: 25, 25
mesh_max: 275, 265
probe_count: 20, 20

[adxl345]
cs_pin: can0: PB12
spi_software_sclk_pin: can0:PB10
spi_software_mosi_pin: can0:PB11
spi_software_miso_pin: can0:PB2
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345
probe_points:
   150,150,20

# Chamber Lighting
[output_pin caselight]
pin: PD15
#max_power: 1.0
#kick_start_time: 0.5
pwm: true
shutdown_value: 0
value: 1
cycle_time: 0.01
#scale: 100

[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
number_of_results_to_keep: 3
show_macros_in_webui: True
timeout: 300
dpi: 300

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.133
#*# pid_ki = 1.324
#*# pid_kd = 289.094
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 20.058
#*# pid_ki = 1.438
#*# pid_kd = 69.955
#*#
#*# [input_shaper]
#*#
#*# [skew_correction CaliFlower]
#*# xy_skew = -2.220446049250313e-16
#*# xz_skew = 0.0
#*# yz_skew = 0.0
#*#
#*# [scanner model default]
#*# model_coef = 1.3675403272547682,
#*# 	  1.7937619056573224,
#*# 	  0.7553799487518319,
#*# 	  0.3877014150198633,
#*# 	  0.4184032998143007,
#*# 	  0.2991069507591693,
#*# 	  -0.2744815254069319,
#*# 	  -0.21061287405141232,
#*# 	  0.2826175667767271,
#*# 	  0.1804372746066715
#*# model_domain = 3.219964566634026e-07,3.359593890061353e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 22.690366
#*# model_offset = 0.30000
#*# model_mode = scan
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.019669, 0.038562, 0.054383, 0.047190, 0.055747, 0.062632, 0.067173, 0.062987, 0.078304, 0.086243, 0.086455, 0.086357, 0.089724, 0.093585, 0.083717, 0.077604, 0.065403, 0.059045, 0.048538, 0.036087
#*# 	  -0.004043, 0.020137, 0.015591, 0.021793, 0.032474, 0.045062, 0.046119, 0.046610, 0.054791, 0.059249, 0.066271, 0.071656, 0.064740, 0.066423, 0.059829, 0.060164, 0.049271, 0.039843, 0.027710, 0.016451
#*# 	  -0.002246, 0.006960, 0.013342, 0.020767, 0.026537, 0.031838, 0.038176, 0.042718, 0.048363, 0.050352, 0.056864, 0.058028, 0.057991, 0.055564, 0.053180, 0.040367, 0.042966, 0.035269, 0.025504, 0.012209
#*# 	  -0.008457, -0.019668, 0.000513, 0.018456, 0.015630, 0.013921, 0.030323, 0.044188, 0.043060, 0.039301, 0.043774, 0.063860, 0.053618, 0.053079, 0.059918, 0.047897, 0.036760, 0.040363, 0.035972, 0.011242
#*# 	  -0.046344, -0.008653, -0.012155, -0.003875, -0.009469, 0.021817, 0.026752, 0.023250, 0.020186, 0.036815, 0.051240, 0.052742, 0.031275, 0.040549, 0.038092, 0.027412, 0.042629, 0.036966, 0.019930, 0.008146
#*# 	  -0.035013, -0.024558, -0.005355, -0.019232, -0.002493, 0.002478, 0.018802, 0.014651, 0.020495, 0.028493, 0.042690, 0.036482, 0.032057, 0.031246, 0.021549, 0.029528, 0.030825, 0.026484, 0.015811, 0.003188
#*# 	  -0.023633, -0.027518, -0.019164, -0.011754, -0.005942, -0.002283, 0.002204, -0.003994, 0.024143, 0.020758, 0.026572, 0.027466, 0.021610, 0.029304, 0.019201, 0.021799, 0.023664, 0.028386, 0.011632, -0.003589
#*# 	  -0.032988, -0.046030, -0.028307, -0.011223, -0.010428, -0.025565, -0.009609, -0.005749, 0.011686, 0.001135, 0.015909, 0.015555, 0.014664, 0.019372, 0.013369, 0.017397, 0.015499, 0.028327, 0.011857, -0.001829
#*# 	  -0.066451, -0.028684, -0.033669, -0.031024, -0.027509, -0.022887, -0.018441, -0.011374, 0.006308, -0.002318, 0.015488, 0.025695, 0.022891, 0.006423, 0.009234, 0.027515, 0.030339, 0.025780, 0.017511, 0.012203
#*# 	  -0.064832, -0.034646, -0.026399, -0.043763, -0.041712, -0.026644, -0.011322, -0.019179, -0.008615, 0.015060, 0.024577, 0.010712, 0.016285, 0.022970, 0.018413, 0.016468, 0.026614, 0.031675, 0.024241, 0.020367
#*# 	  -0.062700, -0.055975, -0.061614, -0.034270, -0.041577, -0.044953, -0.036731, -0.010500, 0.001887, -0.001423, -0.002424, 0.007787, 0.015091, 0.009929, 0.004938, 0.011543, 0.024335, 0.024415, 0.025963, 0.023055
#*# 	  -0.067691, -0.064763, -0.061537, -0.054694, -0.049123, -0.041594, -0.032974, -0.024001, -0.014684, -0.010907, -0.003099, 0.005470, -0.002216, 0.004668, 0.009210, 0.009519, 0.010479, 0.014482, 0.022048, 0.022915
#*# 	  -0.063690, -0.058786, -0.059324, -0.047499, -0.057825, -0.043649, -0.033913, -0.022221, -0.022061, -0.007593, -0.003926, -0.005735, 0.007690, 0.004640, 0.006497, 0.008070, 0.016525, 0.020513, 0.021886, 0.020409
#*# 	  -0.079999, -0.057995, -0.062641, -0.053138, -0.047245, -0.041870, -0.034383, -0.025469, -0.016233, -0.011295, -0.003570, 0.001389, 0.004202, 0.006206, 0.010652, 0.010554, 0.021977, 0.022091, 0.025565, 0.028195
#*# 	  -0.052237, -0.043858, -0.046460, -0.052563, -0.032234, -0.033301, -0.027701, -0.025596, -0.005869, -0.004147, 0.004225, 0.012036, 0.018649, 0.018348, 0.021930, 0.028455, 0.034470, 0.039933, 0.044434, 0.044120
#*# 	  -0.037806, -0.033989, -0.029259, -0.030509, -0.028516, -0.022831, -0.010642, -0.001853, 0.007023, 0.012728, 0.021779, 0.028047, 0.027561, 0.031068, 0.032085, 0.039439, 0.044915, 0.043952, 0.046950, 0.042641
#*# 	  -0.019249, -0.016892, -0.017434, -0.010120, -0.011946, -0.005641, -0.001360, 0.006264, 0.019147, 0.019383, 0.021403, 0.029818, 0.031286, 0.035380, 0.037446, 0.037712, 0.041511, 0.043574, 0.043236, 0.042422
#*# 	  -0.017375, -0.007318, -0.009870, -0.007156, -0.004196, -0.000002, 0.005476, 0.009084, 0.014022, 0.016578, 0.020621, 0.025620, 0.028022, 0.030974, 0.035272, 0.038383, 0.043032, 0.047867, 0.051792, 0.051234
#*# 	  -0.010982, -0.015903, -0.015209, -0.017280, -0.009638, -0.004342, 0.003952, 0.008180, 0.015043, 0.017223, 0.020671, 0.025933, 0.029469, 0.030505, 0.034666, 0.036690, 0.042218, 0.045808, 0.045847, 0.046655
#*# 	  0.047703, 0.033665, 0.013476, 0.007660, 0.005922, 0.011530, 0.016867, 0.022874, 0.025716, 0.030700, 0.031897, 0.034409, 0.035811, 0.036658, 0.036597, 0.037656, 0.039276, 0.042072, 0.040675, 0.039464
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 25.0
#*# max_x = 275.0
#*# min_y = 25.0
#*# max_y = 265.0
